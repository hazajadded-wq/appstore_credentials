workflows:
  salaryinfo-ios-fix:
    name: SalaryInfo iOS Crash Fix
    instance_type: mac_mini_m2
    max_build_duration: 75

    environment:
      groups:
        - appstore_credentials
      
      vars:
        BUNDLE_ID: "com.pocket.salaryinfo"
        APP_STORE_APPLE_ID: 6756042000
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        FLUTTER_BUILD_NAME: "1.0.11"
        FLUTTER_BUILD_NUMBER: "6"
        
      flutter: "3.22.0"  # âœ… SPECIFIC FLUTTER VERSION
      xcode: latest
      cocoapods: default

    scripts:
      # ğŸ” Setup Code Signing
      - name: Setup keychain and certificates
        script: |
          set -e
          keychain initialize
          
          echo "ğŸ” Fetching signing certificates for $BUNDLE_ID"
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create
          
          keychain add-certificates
          xcode-project use-profiles
          
          echo "âœ… Code signing configured"

      # ğŸ§¹ DEEP Clean Project
      - name: Deep clean project
        script: |
          set -e
          echo "ğŸ§¹ Deep cleaning project..."
          
          # Clean Flutter
          flutter clean
          
          # Clean iOS build artifacts
          rm -rf ios/Pods
          rm -rf ios/Podfile.lock
          rm -rf ios/build
          rm -rf ios/.symlinks
          rm -rf ios/Runner.xcworkspace
          rm -rf ios/DerivedData
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          
          # Clean CocoaPods cache
          pod cache clean --all
          rm -rf ~/Library/Caches/CocoaPods
          
          # Clean Flutter pub cache
          rm -rf ~/.pub-cache
          
          echo "âœ… Project deep cleaned"

      # ğŸ“¦ Install Flutter packages WITH RETRY
      - name: Install Flutter packages
        script: |
          set -e
          echo "ğŸ“¦ Installing Flutter packages..."
          
          MAX_ATTEMPTS=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            if flutter pub get --verbose; then
              echo "âœ… Flutter packages installed successfully"
              break
            else
              echo "âš ï¸ Flutter pub get failed on attempt $ATTEMPT"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "Retrying in 5 seconds..."
                rm -rf ~/.pub-cache
                sleep 5
              else
                echo "âŒ Failed after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done

      # ğŸ”§ Verify Firebase files
      - name: Verify Firebase configuration
        script: |
          set -e
          echo "ğŸ” Verifying Firebase configuration..."
          
          # Check GoogleService-Info.plist exists
          if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
            echo "âœ… GoogleService-Info.plist found"
            
            # Check content
            PROJECT_ID=$(/usr/libexec/PlistBuddy -c "Print :PROJECT_ID" ios/Runner/GoogleService-Info.plist 2>/dev/null || echo "NOT_FOUND")
            BUNDLE_ID_PLIST=$(/usr/libexec/PlistBuddy -c "Print :BUNDLE_ID" ios/Runner/GoogleService-Info.plist 2>/dev/null || echo "NOT_FOUND")
            
            echo "ğŸ“Š Firebase Project ID: $PROJECT_ID"
            echo "ğŸ“Š Bundle ID in plist: $BUNDLE_ID_PLIST"
            
            if [ "$PROJECT_ID" = "scgfs-salary-app" ]; then
              echo "âœ… Correct Firebase Project"
            else
              echo "âš ï¸ Unexpected Firebase Project"
            fi
          else
            echo "âŒ GoogleService-Info.plist NOT FOUND!"
            exit 1
          fi
          
          echo "âœ… Firebase configuration verified"

      # ğŸ”„ Update CocoaPods repository
      - name: Update CocoaPods specs
        script: |
          set -e
          echo "ğŸ”„ Updating CocoaPods repository..."
          
          # Update specs to ensure we have latest pod definitions
          pod repo update
          
          echo "âœ… CocoaPods specs updated"

      # ğŸ“± Install iOS pods WITH RETRY LOGIC
      - name: Install iOS pods with retry
        script: |
          set -e
          echo "ğŸ“± Installing iOS pods with retry logic..."
          cd ios
          
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Pod Install Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Try to install pods
            if pod install --repo-update --verbose; then
              echo ""
              echo "âœ… Pod install succeeded on attempt $ATTEMPT!"
              SUCCESS=true
              break
            else
              echo ""
              echo "âŒ Pod install failed on attempt $ATTEMPT"
              
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                echo "ğŸ”§ Cleaning up for retry..."
                
                # Clean up for retry
                rm -rf Pods
                rm -rf Podfile.lock
                rm -rf .symlinks/plugins
                rm -rf ~/Library/Caches/CocoaPods
                pod cache clean --all
                
                echo "â³ Waiting 10 seconds before retry..."
                sleep 10
              fi
              
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          cd ..
          
          if [ "$SUCCESS" = false ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ FATAL: Pod install failed after $MAX_ATTEMPTS attempts"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi

      # ğŸ—‚ï¸ Build iOS App
      - name: Build iOS IPA
        script: |
          set -e
          echo "ğŸ—‚ï¸ Building iOS IPA..."
          
          # Build with verbose output
          flutter build ipa \
            --release \
            --build-name="$FLUTTER_BUILD_NAME" \
            --build-number="$FLUTTER_BUILD_NUMBER" \
            --export-options-plist=export_options.plist \
            --verbose
          
          echo "âœ… IPA built successfully"

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - ios/Podfile.lock

    publishing:
      email:
        recipients:
          - hazajadded@gmail.com
        notify:
          success: true
          failure: true
      
      app_store_connect:
        auth: integration
        submit_to_testflight: true