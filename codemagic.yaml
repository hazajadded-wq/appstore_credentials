workflows:
  salaryinfo-ios-fix:
    name: SalaryInfo iOS Build
    instance_type: mac_mini_m2
    max_build_duration: 75

    environment:
      groups:
        - appstore_credentials
      
      vars:
        BUNDLE_ID: "com.pocket.salaryinfo"
        APP_STORE_APPLE_ID: 6756042000
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        FLUTTER_BUILD_NAME: "1.0.11"
        FLUTTER_BUILD_NUMBER: "7"
        
      flutter: "3.22.0"
      xcode: latest
      cocoapods: default

    scripts:
      - name: Setup code signing
        script: |
          set -e
          keychain initialize
          
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --create
          
          keychain add-certificates
          xcode-project use-profiles

      - name: Force clean Flutter
        script: |
          set -e
          echo "ğŸ§¹ Force cleaning Flutter..."
          
          # Remove Flutter cached artifacts
          rm -rf $FLUTTER_ROOT/.pub-cache
          
          # Clean Flutter build cache
          flutter pub cache clean --force
          
          echo "âœ… Flutter cleaned"

      - name: Clean build
        script: |
          set -e
          flutter clean
          rm -rf ios/Pods ios/Podfile.lock ios/.symlinks ios/build ios/Runner.xcworkspace
          rm -rf ~/Library/Developer/Xcode/DerivedData/*
          pod cache clean --all
          
          # Clean CocoaPods cache more aggressively
          pod deintegrate || true
          rm -rf ~/Library/Caches/CocoaPods
          
          echo "âœ… Build cleaned"

      - name: Get Flutter packages
        script: |
          set -e
          flutter pub get
          echo "âœ… Flutter packages installed"

      - name: Verify Podfile has Firebase fix
        script: |
          set -e
          if ! grep -q "CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES" ios/Podfile; then
            echo "âŒ ERROR: Podfile missing Firebase fix!"
            echo "Your ios/Podfile must have this line in post_install:"
            echo "config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'"
            exit 1
          fi
          echo "âœ… Podfile has Firebase fix"

      - name: Install pods (with retry and verbose)
        script: |
          set -e
          cd ios
          
          # First, ensure pod repo is updated
          echo "ğŸ“¦ Updating CocoaPods repo..."
          pod repo update
          
          for ATTEMPT in 1 2 3; do
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Pod Install Attempt $ATTEMPT of 3"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # Try with verbose output
            if pod install --repo-update --verbose; then
              echo "âœ… Pod install succeeded!"
              
              # Verify the settings were applied
              echo "ğŸ” Checking build settings..."
              if xcodebuild -workspace Runner.xcworkspace -scheme Runner -showBuildSettings | grep -q "CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES = YES"; then
                echo "âœ… Build setting verified"
              else
                echo "âš ï¸ Build setting not found in project"
              fi
              
              cd ..
              exit 0
            fi
            
            if [ $ATTEMPT -lt 3 ]; then
              echo "ğŸ”„ Retrying..."
              rm -rf Pods Podfile.lock
              pod cache clean --all
              sleep 5
            fi
          done
          
          echo "âŒ Pod install failed after 3 attempts"
          cd ..
          exit 1

      - name: Build Flutter framework
        script: |
          set -e
          # Build WITHOUT creating IPA - this won't upgrade Podfile
          flutter build ios --release --no-codesign
          echo "âœ… Flutter framework built"

      - name: Create Xcode archive
        script: |
          set -e
          cd ios
          
          xcodebuild \
            -workspace "$XCODE_WORKSPACE" \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath build/Runner.xcarchive \
            -destination 'generic/platform=iOS' \
            archive
          
          echo "âœ… Archive created"
          cd ..

      - name: Export IPA
        script: |
          set -e
          cd ios
          
          xcodebuild \
            -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist /Users/builder/export_options.plist
          
          mkdir -p ../build/ios/ipa
          cp build/ipa/*.ipa ../build/ios/ipa/
          
          echo "âœ… IPA exported successfully"
          ls -lh ../build/ios/ipa/
          
          cd ..

    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - ios/Podfile.lock

    publishing:
      email:
        recipients:
          - hazajadded@gmail.com
        notify:
          success: true
          failure: true
      
      app_store_connect:
        auth: integration
        submit_to_testflight: true